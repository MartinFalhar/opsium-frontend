RoÄnÃ­ restart ÄÃ­selnÃ© Å™ady je klasickÃ½ poÅ¾adavek ğŸ‘
NejÄistÅ¡Ã­ Å™eÅ¡enÃ­ v PostgreSQL je zahrnout rok pÅ™Ã­mo do logiky ÄÃ­slovÃ¡nÃ­ a oddÄ›lit Å™ady podle (id_branches, rok).

UkÃ¡Å¾u robustnÃ­ a bÄ›Å¾nÄ› pouÅ¾Ã­vanÃ© Å™eÅ¡enÃ­.

âœ… Princip Å™eÅ¡enÃ­

ÄŒÃ­selnÃ¡ Å™ada se resetuje automaticky 1. 1., protoÅ¾e:

ÄÃ­slo se poÄÃ­tÃ¡ jen z faktur stejnÃ©ho roku

rok se bere z issued_at (ne z created_at!)

1ï¸âƒ£ PÅ™idej sloupec issued_at (pokud ho nemÃ¡Å¡)
ALTER TABLE invoices
ADD COLUMN issued_at DATE;


ğŸ“Œ Pokud uÅ¾ existuje, tento krok pÅ™eskoÄ.

2ï¸âƒ£ Uprav unikÃ¡tnost â€“ pÅ™idej rok

ZruÅ¡ starÃ½ index (pokud existuje):

DROP INDEX IF EXISTS uniq_invoice_number_per_branch;


VytvoÅ™ novÃ½:

CREATE UNIQUE INDEX uniq_invoice_number_branch_year
ON invoices (
  id_branches,
  EXTRACT(YEAR FROM issued_at),
  number
);

3ï¸âƒ£ Trigger funkce s roÄnÃ­m resetem
CREATE OR REPLACE FUNCTION invoice_number_per_branch_year()
RETURNS trigger AS $$
DECLARE
  current_year INTEGER;
BEGIN
  -- pokud nenÃ­ issued_at, pouÅ¾ij dneÅ¡ek
  IF NEW.issued_at IS NULL THEN
    NEW.issued_at := CURRENT_DATE;
  END IF;

  current_year := EXTRACT(YEAR FROM NEW.issued_at);

  IF NEW.number IS NULL THEN
    SELECT COALESCE(MAX(number), 0) + 1
    INTO NEW.number
    FROM invoices
    WHERE id_branches = NEW.id_branches
      AND EXTRACT(YEAR FROM issued_at) = current_year;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

4ï¸âƒ£ Trigger
DROP TRIGGER IF EXISTS trg_invoice_number ON invoices;

CREATE TRIGGER trg_invoice_number
BEFORE INSERT ON invoices
FOR EACH ROW
EXECUTE FUNCTION invoice_number_per_branch_year();

ğŸ¯ VÃ½sledek

kaÅ¾dÃ¡ poboÄka mÃ¡ novou Å™adu kaÅ¾dÃ½ rok

Å¾Ã¡dnÃ½ ruÄnÃ­ reset

DB sama hlÃ­dÃ¡ unikÃ¡tnost

bezpeÄnÃ© i pÅ™i paralelnÃ­ch vkladech

ğŸ’¡ DoporuÄenÃ­ navÃ­c (best practice)
FormÃ¡t faktury uklÃ¡dej oddÄ›lenÄ›
number = 15
issued_at = 2026-03-12


FormÃ¡tuj aÅ¾ v aplikaci:

2026-0015

ğŸ§  ChceÅ¡ jeÅ¡tÄ› lepÅ¡Ã­ Å™eÅ¡enÃ­?

Mohu ti ukÃ¡zat:

tabulku invoice_counters (100% bezpeÄnÃ© pÅ™i vysokÃ© zÃ¡tÄ›Å¾i)

reset pÅ™i zmÄ›nÄ› statusu na issued

ÄÃ­slovÃ¡nÃ­ zakÃ¡zek â‰  faktur

retroaktivnÃ­ dopoÄÃ­tÃ¡nÃ­ starÃ½ch let

StaÄÃ­ Å™Ã­ct ğŸ‘