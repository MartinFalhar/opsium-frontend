chci pÅ™idat sloupec number kterÃ¡ bude sledovat ÄÃ­selnou Å™adu zakÃ¡zky (kaÅ¾dÃ¡ id_branches bude svou Å™adu). Tabulka ale jiÅ¾ obsahuje 19 zÃ¡znamÅ¯.

RozumnÃ© Å™eÅ¡enÃ­ ğŸ‘
ProtoÅ¾e tabulka uÅ¾ mÃ¡ 19 zÃ¡znamÅ¯ a ÄÃ­selnÃ¡ Å™ada je zvlÃ¡Å¡Å¥ pro kaÅ¾dÃ© id_branches, je potÅ™eba postupovat ve 3 krocÃ­ch:

ğŸ§± 1ï¸âƒ£ PÅ™idÃ¡nÃ­ sloupce number (zatÃ­m bez unikÃ¡tnosti)
NejdÅ™Ã­v jen technicky pÅ™idÃ¡me sloupec, aby se vyplnil u stÃ¡vajÃ­cÃ­ch Å™Ã¡dkÅ¯.
ALTER TABLE invoices
ADD COLUMN number INTEGER;


âš ï¸ ZatÃ­m bez NOT NULL a bez DEFAULT


ğŸ”„ 2ï¸âƒ£ DopoÄÃ­tÃ¡nÃ­ ÄÃ­selnÃ© Å™ady pro EXISTUJÃCÃ zÃ¡znamy
KaÅ¾dÃ¡ poboÄka (id_branches) dostane vlastnÃ­ Å™adu od 1 nahoru.
WITH ranked AS (
  SELECT
    id,
    ROW_NUMBER() OVER (
      PARTITION BY id_branches
      ORDER BY created_at, id
    ) AS rn
  FROM invoices
)
UPDATE invoices i
SET number = r.rn
FROM ranked r
WHERE i.id = r.id;

ğŸ“Œ Å˜azenÃ­:


primÃ¡rnÄ› created_at


fallback id (pro jistotu)



ğŸ”’ 3ï¸âƒ£ ZpÅ™Ã­snÄ›nÃ­ pravidel (NOT NULL + unikÃ¡tnost)
TeÄ uÅ¾ vÃ­me, Å¾e kaÅ¾dÃ½ Å™Ã¡dek mÃ¡ ÄÃ­slo.
ALTER TABLE invoices
ALTER COLUMN number SET NOT NULL;

UnikÃ¡tnÃ­ ÄÃ­slo v rÃ¡mci poboÄky
CREATE UNIQUE INDEX uniq_invoice_number_per_branch
ON invoices (id_branches, number);


â• 4ï¸âƒ£ AutomatickÃ© ÄÃ­slovÃ¡nÃ­ pro NOVÃ‰ faktury
PostgreSQL neumÃ­ â€sekvenci per branchâ€œ, takÅ¾e se to Å™eÅ¡Ã­ triggerem.
Trigger funkce
CREATE OR REPLACE FUNCTION invoice_number_per_branch()
RETURNS trigger AS $$
BEGIN
  IF NEW.number IS NULL THEN
    SELECT COALESCE(MAX(number), 0) + 1
    INTO NEW.number
    FROM invoices
    WHERE id_branches = NEW.id_branches;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

Trigger
CREATE TRIGGER trg_invoice_number
BEFORE INSERT ON invoices
FOR EACH ROW
EXECUTE FUNCTION invoice_number_per_branch();


âœ… VÃ½sledek


kaÅ¾dÃ¡ poboÄka mÃ¡ vlastnÃ­ ÄÃ­selnou Å™adu


starÃ¡ data jsou sprÃ¡vnÄ› dopoÄÃ­tanÃ¡


novÃ© faktury se ÄÃ­slujÃ­ automaticky


DB nedovolÃ­ duplicitu



ğŸ’¡ DoporuÄenÃ­ z praxe
Pokud budeÅ¡ chtÃ­t:


roÄnÄ› resetovat Å™adu (2026/001)


nebo mÃ­t ÄÃ­slo zakÃ¡zky â‰  ÄÃ­slo faktury


nebo generovat ÄÃ­slo aÅ¾ pÅ™i issued statusu


â†’ napiÅ¡, to uÅ¾ je jen malÃ¡ Ãºprava logiky ğŸ‘Œ